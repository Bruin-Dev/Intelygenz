version: '3.1'
services:
  nats-streaming:
    image: samunozjigz/nats-s-cfile:latest
    restart: on-failure
    build:
      context: ./nats-streaming-server
    ports:
      - 4222:4222
      - 8222:8222

  # EXAMPLE OF BASE-MICROSERVICE
  # ============================
  #  base-microservice:
  #    build:
  #      # Context must be the root of the monorepo since we need to copy custompackages
  #      context: .
  #      dockerfile: base-microservice/Dockerfile
  #    env_file:
  #      - base-microservice/src/config/env
  #    depends_on:
  #      - "nats-streaming"
  #    ports:
  #      - 9100:9100
  # ============================
  velocloud-overseer:
    build:
      # Context must be the root of the monorepo since we need to copy custompackages
      context: .
      dockerfile: velocloud-overseer/Dockerfile
    env_file:
      - velocloud-overseer/src/config/env
    depends_on:
      - "nats-streaming"
    ports:
      - 5000:5000

  velocloud-drone:
    build:
      # Context must be the root of the monorepo since we need to copy custompackages
      context: .
      dockerfile: velocloud-drone/Dockerfile
    env_file:
      - velocloud-drone/src/config/env
    depends_on:
      - "nats-streaming"
    ports:
      - 5001:5000
      - 9200:9200

  velocloud-notificator:
    build:
      # Context must be the root of the monorepo since we need to copy custompackages
      context: .
      dockerfile: velocloud-notificator/Dockerfile
    env_file:
      - velocloud-notificator/src/config/env
    depends_on:
      - "nats-streaming"
    ports:
      - 5002:5000

  prometheus:
    image: prom/prometheus:v2.7.2
    restart: unless-stopped
    volumes:
      - ./metrics-dashboard/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    ports:
      - 9090:9090

  grafana:
    image: grafana/grafana:6.0.1
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=q1w2e3r4
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    depends_on:
      - prometheus
    restart: unless-stopped
    ports:
      - 3000:3000
    volumes:
      - ./metrics-dashboard/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./metrics-dashboard/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./metrics-dashboard/grafana/dashboards-definitions:/var/lib/grafana/dashboards
