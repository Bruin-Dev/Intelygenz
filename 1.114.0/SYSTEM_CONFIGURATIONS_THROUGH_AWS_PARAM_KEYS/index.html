
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.mettel-automation.net/1.114.0/SYSTEM_CONFIGURATIONS_THROUGH_AWS_PARAM_KEYS/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.11">
    
    
      
        <title>SYSTEM CONFIGURATIONS THROUGH AWS PARAM KEYS - Automation Engine Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8c5ef100.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#context" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Automation Engine Documentation" class="md-header__button md-logo" aria-label="Automation Engine Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Automation Engine Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SYSTEM CONFIGURATIONS THROUGH AWS PARAM KEYS
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../CONCEPTS/" class="md-tabs__link">
        Topics
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Automation Engine Documentation" class="md-nav__button md-logo" aria-label="Automation Engine Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Automation Engine Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../CONCEPTS/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Pipelines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pipelines" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Pipelines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/BASIC_CI_CONFIGURATION/" class="md-nav__link">
        Basic configurations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/PIPELINE_RULES/" class="md-nav__link">
        Pipeline rules
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentation" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../DOCUMENTATION/" class="md-nav__link">
        Organization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/" class="md-nav__link">
        MetTel decisions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../metrics-definitions/" class="md-nav__link">
        Metrics definitions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Development rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          Work in a local env
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Work in a local env" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Work in a local env
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/LAUNCH_DOCKER_COMPOSE/" class="md-nav__link">
        Launch docker compose
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../snowflake/" class="md-nav__link">
        Datalake
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Manual processes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<div align="center">
<img src="https://media.licdn.com/dms/image/C4E0BAQHrME9aCW6ulg/company-logo_200_200/0?e=2159024400&v=beta&t=6xMNS1zK1F8asBlM16EzbJ4Im7SlQ8L7a7sgcaNzZQE"  width="200" height="200">
</div>

<h1 id="context">Context</h1>
<p>Configurations are stored in <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html">AWS Systems Manager Parameter Store</a>.</p>
<p>Parameter Store is a capability of AWS Systems Manager that allows storing configuration values in hierarchical structures. It also provides the ability to encrypt
these values through <a href="https://aws.amazon.com/kms/">AWS KMS</a> keys, and allows keeping track of configuration changes / versions for auditing purposes.</p>
<p>From a pricing perspective, parameters can be defined either as <strong>simple</strong> or <strong>advanced</strong>:
- <strong>Simple</strong>. This kind of parameters come with no additional charges, and can hold up to 4KB of data. Parameter Store allows defining up to 10,000 simple parameters
  per account and region.
- <strong>Advanced</strong>. AWS charges $0.05 per advanced parameter per month. These can hold up to 8KB of data, and Parameter Store allows defining up to 100,000 of them
  per account and region.</p>
<p>Attending to their type, parameters can be defined as:
* <strong>String</strong>. These parameters consist of a block of text. Nothing else.
* <strong>StringList</strong>. These parameters hold comma-separated values, but bear in mind that this is just a convention. AWS will <strong>not</strong> turn the value into an array before
  returning it through Parameter Store API; that is, it will be kept as a string.
* <strong>SecureString</strong>. Essentially, these are the same as <strong>String</strong> parameters, but empowered with encryption features thanks to KMS keys.</p>
<h1 id="conventions">Conventions</h1>
<p>Please, take some time to go through the following conventions before publishing new parameters to Parameter Store.</p>
<h2 id="parameter-names">Parameter names</h2>
<p>Any new configuration published to Parameter Store must match the following pattern:</p>
<pre><code>/automation-engine/&lt;environment&gt;/&lt;service-name&gt;/&lt;parameter&gt;
</code></pre>
<p>where:
* <strong>environment</strong> refers to the Kubernetes context whose namespaces will take this parameter. Allowed values are <code>dev</code>, <code>pro</code> and <code>common</code>.
* <strong>service-name</strong> refers to the name of the service this parameter will be loaded to. Examples of allowed values would be <code>bruin-bridge</code>,
  <code>tnba-monitor</code>, <code>repair-tickets-monitor</code>, and so on.
* <strong>parameter</strong> refers to the name of the parameter that will be loaded to the service through an environment variable.</p>
<p>Most configurations will follow the previous pattern, but if the business logic of a service carries out several tasks related to the same
domain concept, an alternate form can be used:</p>
<pre><code>/automation-engine/&lt;environment&gt;/&lt;domain&gt;/&lt;task&gt;/&lt;parameter&gt;
</code></pre>
<p>where:
* <strong>domain</strong> refers to a domain concept that can represent multiple tasks accurately. An example would be <code>service-affecting</code>,
  which is a domain area that represents strongly related tasks (in this case, tasks related to Service Affecting troubles).
* <strong>task</strong> refers to the underlying piece of logic that is independent of other tasks, but is still suitable to have under the
  subpath defined by <code>domain</code>. Considering that <code>domain</code> is set to <code>service-affecting</code>, acceptable values for <code>task</code> would be
  <code>monitor</code>, <code>daily-bandwidth-report</code>, or <code>reoccurring-trouble-report</code>.</p>
<p>As a rule of thumb, choose the first pattern to name parameters if possible. However, if there is a strong
reason to choose the second pattern over the first one, that is totally fine.</p>
<p>If there are doubts about choosing one or the other, it can be brought up to discussion with the rest of the team.</p>
<h2 id="values">Values</h2>
<p>Before getting into how to define new configurations, bear these considerations in mind  to keep certain consistency and avoid confusion / potential errors:
* Values representing a time duration <strong>must</strong> always be expressed in seconds.
  * <code>24</code> should not be used to represent the hours in a period of 1 day.
  * <code>86400</code> should be used to represent the hours in a period of 1 day.</p>
<ul>
<li>Values representing percentages <strong>must</strong> always be expressed in their integer form.</li>
<li><code>0.75</code> should not be used to represent the value <code>75%</code>.</li>
<li>
<p><code>75</code> should be used to represent the value <code>75%</code>.</p>
</li>
<li>
<p>JSON-like values <strong>must</strong> adhere to the <a href="https://www.json.org/json-en.html">JSON specification</a>. The most relevant considerations are:</p>
</li>
<li>
<p>All keys in an object-like JSON must be strings, even if they represent numbers.</p>
<p>Example:
 ```json
 // NOT valid
 {
     1: "foo",
     2: "bar"
 }</p>
<p>// Valid
 {
     "1": "foo",
     "2": "bar"
 }</p>
<p>// Valid
 {
     "foo": "bar",
     "baz": "hey"
 }
 ```
  2. An array-like JSON can hold a combination of values with different types, be them integers, floats, boolean, arrays, objects, and so on.</p>
<p>Example:
 <code>json
 [
     1,
     "foo",
     0.75,
     "2",
     "bar",
     true,
     [
        "hello",
        "world"
     ],
     {
        "hello": "world"
     }
 ]</code></p>
</li>
<li>
<p>Consider prettifying JSON-like configurations before publishing to Parameter Store. This enhances readability when
  dealing with huge JSONs.</p>
</li>
</ul>
<p><strong>Developers are responsible for making any necessary transformations related to data types, time conversions, etc. in the config files
of a particular service</strong>.</p>
<h2 id="encryption">Encryption</h2>
<p>A parameter must be encrypted if it holds:
* Personally Identifiable Information. This includes e-mail addresses, names, surnames, phone numbers, and so on.
* Authentication credentials of any kind.
* URLs from third party services.
* Information related to application domains, such as:
  * IDs (even incremental ones)
  * Organization names
  * Domain-related values that potentially expose internal details about third party systems</p>
<h1 id="publishing-configurations-to-parameter-store">Publishing configurations to Parameter Store</h1>
<p>Adding new configurations to Parameter Store is pretty straightforward. The process should be as easy as:
1. Access the AWS Management Console.
2. Go to the AWS Systems Manager Parameter Store dashboard.
3. Hit <code>Create parameter</code>.
4. Give the parameter a <code>Name</code> that complies with any of the patterns under the <a href="#parameter-names">Parameter names</a> section.
5. Make sure to add a meaningful <code>Description</code> to the parameter. <strong>This is extremely important to give context</strong> to anyone in need of making
   changes to parameters, so take some time to think about a good, meaningful description.
6. Choose the tier that fits better for this parameter:
   1. If the parameter is small and is not expected to grow much as time passes, choose <code>Standard</code>.
   2. On the other hand, if the parameter is large enough and is expected to grow, choose <code>Advanced</code>.
7. Choose the type that fits better for this parameter:
   1. If the parameter is safe to stay unencrypted in AWS:
      1. Choose <code>String</code>.
      2. Set the <code>Data Type</code> field to <code>text</code>.
   2. On the other hand, if the parameter needs to be encrypted (see the <a href="#encryption">Encryption</a> section):
      1. Choose <code>SecureString</code>.
      2. Set the <code>KMS Key Source</code> field to <code>My current account</code> to pick a KMS key registered in the current account.
      3. Set the <code>KMS Key ID</code> field to <code>alias/aws/ssm</code> to pick the default KMS key for Parameter Store.</p>
<blockquote>
<p>In general, avoid using <code>StringList</code> parameters. These are special cases of the <code>String</code> type, which essentially means
that <code>String</code> can be used to create parameters based on comma-separated values as well.
8. Give the parameter a value that adheres to the conventions specified in the <a href="#values">Values</a> section.
9. Finally, hit <code>Create parameter</code> to save it.</p>
</blockquote>
<h2 id="about-the-different-environments">About the different environments</h2>
<p>When creating a new parameter in the Parameter Store, please decide if it will be different on <code>dev</code> and <code>pro</code> or if it will be same in both environments.
If they're different, you should create a parameter for each environment. Otherwise, just create one under <code>common</code>.
In general, most parameters will share the same value, unless there is a strong reason to keep them different.</p>
<p>For example, parameters used to point to third party systems may differ if their app has not only a Production system,
but also a Development / Test one. In that case, the <code>pro</code> version of the parameter should aim at the third party's Production system,
and the <code>dev</code> version should aim at their Development / Test system.</p>
<h1 id="hooking-aws-parameter-store-with-kubernetes-clusters">Hooking AWS Parameter Store with Kubernetes clusters</h1>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>Before moving on, make sure to install <a href="https://github.com/derailed/k9s">k9s</a> in your system. <code>k9s</code> is a powerful terminal UI
that lets users manage Kubernetes clusters from their own machines, and even edit Kubernetes objects in place to reflect those changes
immediately.</p>
<p>After installing <code>k9s</code>, follow these steps to install a plugin that allows editing decoded <code>Secret</code> objects (more in the next section):
1. Install <a href="https://github.com/kubernetes-sigs/krew#installation">krew</a>, following the instructions for the desired OS.
2. Install <code>kubectl</code>'s plugin <a href="https://github.com/rajatjindal/kubectl-modify-secret#installing">kubectl-modify-secret</a>, following
   the instructions for the desired OS.
3. Integrate <code>kubectl-modify-secret</code> into <code>k9s</code>'s plugin system:
   1. In a terminal, run <code>k9s info</code> to check which folder holds <code>k9s</code> configurations.
   2. Create file <code>plugin.yml</code> under that folder, if it does not exist yet.
   3. Add the following snippet:
      <code>yaml
      plugin:
        edit-secret:
          shortCut: Ctrl-X
          confirm: false
          description: "Edit Decoded Secret"
          scopes:
            - secrets
          command: kubectl
          background: false
          args:
            - modify-secret
            - --namespace
            - $NAMESPACE
            - --context
            - $CONTEXT
            - $NAME</code>
      &gt; By default, the shortcut to edit decoded secrets is set to <code>Ctrl</code>+<code>X</code>. If needed, set a custom one instead.</p>
<h2 id="kubernetes-secrets-and-configmaps">Kubernetes: Secrets and ConfigMaps</h2>
<p><code>Secret</code> and <code>ConfigMap</code> objects are the Kubernetes objects used to inject environment variables to one or multiple pods.
Like other Kubernetes objects, they are defined through <code>.yaml</code> files.</p>
<p>These objects hold mappings between environment variables and their values, along with some metadata.</p>
<p>Here is an example of a <code>ConfigMap</code> definition:</p>
<pre><code class="language-yaml">apiVersion: v1
data:
  CURRENT_ENVIRONMENT: production
  ENVIRONMENT_NAME: production
  REDIS_HOSTNAME: redis.pro.somewhere.com
kind: ConfigMap
metadata:
  annotations:
    meta.helm.sh/release-name: automation-engine
    meta.helm.sh/release-namespace: automation-engine
    reloader.stakater.com/match: &quot;true&quot;
  creationTimestamp: &quot;2021-08-30T15:08:12Z&quot;
  labels:
    app.kubernetes.io/instance: automation-engine
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: some-fancy-bridge
    app.kubernetes.io/version: 1.16.0
    component: some-fancy-bridge
    current-environment: production
    environment-name: production
    helm.sh/chart: some-fancy-bridge-0.1.0
    microservice-type: case-of-use
    project: mettel-automation
  name: some-fancy-bridge-configmap
  namespace: automation-engine
  resourceVersion: &quot;83171937&quot;
  selfLink: /api/v1/namespaces/automation-engine/configmaps/some-fancy-bridge-configmap
  uid: ba625451-8ba4-4ac7-a8da-593cc938eae7
</code></pre>
<p>And here is an example of a <code>Secret</code> definition:</p>
<pre><code class="language-yaml">apiVersion: v1
data:
  THIRD_PARTY_API_USERNAME: aGVsbG8K
  THIRD_PARTY_API_PASSWORD: d29ybGQK
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: automation-engine
    meta.helm.sh/release-namespace: automation-engine
    reconcile.external-secrets.io/data-hash: 3162fd065a6777587e9a3a604e0c56e2
    reloader.stakater.com/match: &quot;true&quot;
  creationTimestamp: &quot;2022-03-08T18:31:36Z&quot;
  labels:
    app.kubernetes.io/instance: automation-engine
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: some-fancy-bridge
    app.kubernetes.io/version: 1.16.0
    component: some-fancy-bridge
    current-environment: production
    environment-name: production
    helm.sh/chart: some-fancy-bridge-0.1.0
    microservice-type: capability
    project: mettel-automation
  name: some-fancy-bridge-secret
  namespace: automation-engine
  ownerReferences:
  - apiVersion: external-secrets.io/v1alpha1
    blockOwnerDeletion: true
    controller: true
    kind: ExternalSecret
    name: some-fancy-bridge-secret
    uid: 42bdad1c-37c4-4890-b86b-d9623333df18
  resourceVersion: &quot;82588568&quot;
  selfLink: /api/v1/namespaces/automation-engine/secrets/some-fancy-bridge-secret
  uid: 81ad3356-8696-406e-bba0-c4ec389676ee
type: Opaque
</code></pre>
<p>Both objects have a <code>data</code> field where the different configurations are stored. The main difference between both objects
is that all fields under <code>data</code> remain clear in <code>ConfigMap</code> objects, but in <code>Secret</code> ones, these fields are base64-encoded.</p>
<p>These objects lack of mechanisms to pull configurations from external sources, so an additional tool is needed to hook them
with AWS Parameter Store.</p>
<h2 id="external-secrets">External secrets</h2>
<p>The (External Secrets Operator)[https://github.com/external-secrets/external-secrets] is a tool that allows setting up <code>Secret</code>
objects based on external references through a new kind of object called <code>ExternalSecret</code>.</p>
<p><code>ExternalSecret</code> objects define the external source to pull configurations from, and the references that should be resolved. After
these references have been resolved, the <code>ExternalSecret</code> will create a regular <code>Secret</code> object with a <code>data</code> section whose key-value pairs
are based on the environment variables the pod expects to see, and the values gotten after resolving the references from the external
source.</p>
<p>Aside from that, <code>ExternalSecret</code> objects pull configuration values from the external source periodically to keep secrets up to date,
also known as <em>reconciling secrets</em>.</p>
<p>An example of <code>ExternalSecret</code> object would be this one:</p>
<pre><code class="language-yaml">apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  annotations:
    meta.helm.sh/release-name: automation-engine
    meta.helm.sh/release-namespace: automation-engine
    reloader.stakater.com/match: &quot;true&quot;
  creationTimestamp: &quot;2022-03-08T18:11:02Z&quot;
  generation: 1
  labels:
    app.kubernetes.io/instance: automation-engine
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: some-fancy-bridge
    app.kubernetes.io/version: 1.16.0
    component: some-fancy-bridge
    current-environment: production
    environment-name: production
    helm.sh/chart: some-fancy-bridge-0.1.0
    microservice-type: capability
    project: mettel-automation
  name: some-fancy-bridge-secret
  namespace: automation-engine
  resourceVersion: &quot;83201847&quot;
  selfLink: /apis/external-secrets.io/v1alpha1/namespaces/automation-engine/externalsecrets/some-fancy-bridge-secret
  uid: ca5c1faf-1b76-4f59-b57f-e10e43154ace
spec:
  data:
  - remoteRef:
      key: /automation-engine/pro/some-fancy-bridge/some-common-value
    secretKey: SOME_COMMON_VALUE
  - remoteRef:
      key: /automation-engine/pro/some-fancy-bridge/some-env-specific-value
    secretKey: SOME_ENV_SPECIFIC_VALUE
status:
  conditions:
  - lastTransitionTime: &quot;2022-03-08T18:11:10Z&quot;
    message: Secret was synced
    reason: SecretSynced
    status: &quot;True&quot;
    type: Ready
  refreshTime: &quot;2022-03-10T13:29:12Z&quot;
  syncedResourceVersion: 1-3efb62db37d8b935be922ecc6f7ed99f
</code></pre>
<p>In this example, there are two items under the <code>data</code> section. Each item refers to an external / remote reference (field <code>remoteRef::key</code>),
and the environment variable that the value behind that remote reference should be loaded to (field <code>secretKey</code>).</p>
<h2 id="manipulating-external-secrets-in-the-automation-system">Manipulating external secrets in the Automation system</h2>
<p>To add, remove, or update external secrets for a particular service in the Automation system, head to
<code>helm/charts/automation-engine/&lt;service&gt;/templates/external-secret.yaml</code> and make the appropriate changes under the <code>data</code>
section.</p>
<p>For example, consider the following <code>external-secret.yaml</code>:</p>
<pre><code class="language-yaml">{{- if and .Values.global.externalSecrets.enabled -}}
apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: {{ include &quot;some-fancy-bridge.secretName&quot; . }}
  labels:
    {{- include &quot;some-fancy-bridge.labels&quot; . | nindent 4 }}
  annotations:
    reloader.stakater.com/match: &quot;true&quot;
spec:
  secretStoreRef:
    name: {{ .Values.global.environment }}-parameter-store
    kind: SecretStore 
  target:
    creationPolicy: 'Owner'
   Valid time units are &quot;ns&quot;, &quot;us&quot; (or &quot;µs&quot;), &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot; (from time.ParseDuration)
   May be set to zero to fetch and create it 
  {{- if eq .Values.global.current_environment &quot;dev&quot; }}
  refreshInterval: &quot;0&quot;
  {{ else }}
  refreshInterval: &quot;5m&quot;
  {{- end }}
  data:
    {{- with .Values.global.externalSecrets.envPath }}
    - remoteRef:
        key: {{ .commonPath }}/some-fancy-bridge/some-common-value
      secretKey: SOME_COMMON_VALUE
    - remoteRef:
        key: {{ .envPath }}/some-fancy-bridge/some-env-specific-value
      secretKey: SOME_ENV_SPECIFIC_VALUE
    {{- end }}
{{- end }}
</code></pre>
<p>If a new configuration called <code>THIRD_PARTY_API_URL</code> must be added to the underlying <code>Secret</code> created by this <code>ExternalSecret</code>, a new item should be
placed under the <code>data</code> section, and it should look like this:</p>
<pre><code class="language-yaml">- remoteRef:
    key: {{ . }}/some-fancy-bridge/third-party-api-url
  secretKey: THIRD_PARTY_API_URL
</code></pre>
<p>The change can then be deployed to the Kubernetes cluster.</p>
<h3 id="a-word-of-caution-about-ephemeral-environments">A word of caution about ephemeral environments</h3>
<p>Although <code>external-secrets</code> is part of the EKS cluster for production and the cluster for
ephemeral environments, the truth is it behaves differently across contexts.</p>
<p>In the production cluster, <code>ExternalSecret</code> objects are configured to pull configurations from AWS Parameter Store
every <code>5 minutes</code>. That way, if a developer adds, removes, or updated a parameter in AWS, the cluster will realize about
that event to update the regular <code>Secret</code> object created by the <code>ExternalSecret</code> with the most recent value. This will trigger
another piece in the cluster called <a href="https://github.com/stakater/Reloader">reloader</a>, which ultimately will kill any pod
that relies on the updated secret to spin up a new one with the configurations in the updated <code>Secret</code>.</p>
<p>In ephemeral environments however, this is completely different. The <code>ExternalSecret</code> object will create a <code>Secret</code> object
only when the ephemeral environment is deployed for the first time. After it has been deployed, control and management of
<code>Secret</code> objects is delegated to developers; that is, <code>external-secrets</code> will never pull parameters from AWS again.</p>
<p>The reasoning behind this behavior is that these parameters are shared by all ephemeral environments, so if one of them were
to be updated in AWS and the polling rate was set to <code>5 minutes</code>, all ephemeral environments would be updated because they all share
the same reference. So essentially, the set of configurations for ephemeral environments that are stored in AWS are used as a template
to populate <code>ExternalSecret</code> and <code>Secret</code> objects in ephemeral environments. If a secret needs to be updated, <code>k9s</code> should be used
to edit the <code>Secret</code> in place.</p>
<h2 id="using-an-aws-param-key-in-our-services">Using an AWS param key in our services</h2>
<ol>
<li>
<p>Add the new variable to <code>automation-engine/installation-utils/environment_files_generator.py</code></p>
<p><code>python
SERVICE__DOMAIN__PARAM_KEY_NAME = parameters['environment']['service']['domain']['param-key-name']</code>
And inside the env dictionary in the same file
<code>python
f'DOMAIN__PARAM_KEY_NAME={SERVICE__DOMAIN__PARAM_KEY_NAME}',</code></p>
</li>
<li>
<p>Add the new variable as a template to <code>services/&lt;service&gt;/src/config/.template.env</code>
    <code>python
    DOMAIN__PARAM_KEY_NAME=</code></p>
</li>
<li>
<p>Add the new variable retrieving the value from the environment to <code>services/&lt;service&gt;/src/config/config.py</code>
    <code>python
    'param_key_name': (
        os.environ['DOMAIN__PARAM_KEY_NAME']
    ),</code>
    Any parameter that should be used with a primitive type other than <code>str</code>, should be cast here.
    We MUST use primitive types. DO NOT convert values to complex types like <code>timedelta</code> or <code>datetime</code>. 
    Consumers of the service configuration should be responsible for doing that.</p>
</li>
<li>
<p>Add the new variable to <code>services/&lt;service&gt;/src/config/testconfig.py</code> for being available when testing
    <code>python
    'param_key_name': 86400</code></p>
</li>
<li>
<p>After that you can use it in the service
    <code>python
    self._config.MONITOR_CONFIG['param_key_name']</code>
    And while testing
    <code>python
    param_key_name = action._config.MONITOR_CONFIG['param_key_name']</code></p>
</li>
</ol>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.748e2769.min.js"></script>
      
    
  </body>
</html>