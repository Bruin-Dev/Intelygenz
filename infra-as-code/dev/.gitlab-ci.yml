# ===============================================
# Linter validation jobs for infra-as-code module
# ===============================================



# ==================================================
# Terraform deployment jobs for infra-as-code module
# ==================================================
deploy-branches:
  stage: deploy
  extends: .terraform_template_deploy_environment
  variables:
    MODULE: infra-as-code/new-dev
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_ENVIRONMENT=${ENVIRONMENT_SLUG}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
    - export EKS_CLUSTER_NAME="mettel-automation-${TF_VAR_CURRENT_ENVIRONMENT}"
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/'
      when: manual
      allow_failure: true
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never

#deploy-eks-integration:
#  stage: deploy
#  extends: .terraform_template_deploy_eks
#  variables:
#    MODULE: infra-as-code/eks
#    EKS_MODULE: 2-create-eks-cluster
#    IAM_TO_EKS_ROLES: developer, devops
#    KUBERNETES_METRICS_SERVER_V: ${KUBERNETES_METRICS_SERVER_DEV}
#  before_script:
#    - export ENVIRONMENT_SLUG="production"
#    - export TF_VAR_ENVIRONMENT=${ENVIRONMENT_SLUG}
#    - export TF_VAR_CURRENT_ENVIRONMENT=production
#    - export EKS_CLUSTER_NAME="mettel-automation"
#  rules:
#    - if: '$CI_COMMIT_BRANCH == "master"'

# ===============================================
# Terraform destroy jobs for infra-as-code module
# ===============================================
destroy-branches:
  stage: destroy
  extends: .terraform_template_destroy_environment
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_ENVIRONMENT=${ENVIRONMENT_SLUG}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
    - export EKS_CLUSTER_NAME="mettel-automation-${TF_VAR_CURRENT_ENVIRONMENT}"
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/'
      when: manual
      allow_failure: true
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
#  needs:
#    - deploy-branches

destroy-branches-aws-nuke:
  stage: destroy
  extends: .destroy_environment_aws_nuke_template
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: never
    - if: $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/
      when: manual
      allow_failure: true