# ============================================================
# Linter validation jobs for infra-as-code/elasticaches module
# ============================================================

terraform-valite-elasticaches:
  stage: validation
  extends: .terraform_dirs_validate_template
  variables:
    MODULE: "infra-as-code/elasticaches"
  before_script:
    - export TF_VAR_CURRENT_ENVIRONMENT="dev"
  rules:
    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && $CI_PIPELINE_SOURCE == "web"'
      changes:
        - infra-as-code/elasticaches/**/*
    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && $CI_PIPELINE_SOURCE == "push"'

# ===============================================================
# Terraform deployment jobs for infra-as-code/elasticaches module
# ===============================================================
deploy-elastic-branches:
  stage: deploy
  extends: .terraform_template_deploy_elastic
  variables:
    MODULE: infra-as-code/elasticaches
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_ENVIRONMENT=${ENVIRONMENT_SLUG}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
    - export EKS_CLUSTER_NAME="mettel-automation-${TF_VAR_CURRENT_ENVIRONMENT}"
  environment:
    name: $CI_COMMIT_REF_NAME
    on_stop: destroy-elastic-branches
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/'
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never

deploy-elastic-master:
  stage: deploy
  extends: .terraform_template_deploy_elastic
  variables:
    MODULE: infra-as-code/elasticaches
  before_script:
    - export TF_VAR_ENVIRONMENT=production
    - export TF_VAR_CURRENT_ENVIRONMENT=production
    - export EKS_CLUSTER_NAME="mettel-automation"
  environment:
    name: $CI_COMMIT_REF_NAME
    on_stop: destroy-elastic-master
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true

# ============================================================
# Terraform destroy jobs for infra-as-code/elasticaches module
# ============================================================
destroy-elastic-branches:
  stage: destroy
  extends: .terraform_template_destroy_elastic
  variables:
    MODULE: infra-as-code/elasticaches
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_ENVIRONMENT=${ENVIRONMENT_SLUG}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
    - export EKS_CLUSTER_NAME="mettel-automation-${TF_VAR_CURRENT_ENVIRONMENT}"
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/'
      when: manual
      allow_failure: true
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
#  needs:
#    - deploy-elastic-branches

destroy-elastic-master:
  stage: destroy
  extends: .terraform_template_destroy_elastic
  variables:
    MODULE: infra-as-code/elasticaches
  before_script:
    - export TF_VAR_ENVIRONMENT=production
    - export TF_VAR_CURRENT_ENVIRONMENT=production
    - export EKS_CLUSTER_NAME="mettel-automation"
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
#  needs:
#    - deploy-elastic-master