# ===============================================
# Linter validation jobs for infra-as-code module
# ===============================================
terraform-validate-basic-infra:
  stage: validation
  extends: .terraform_basic_template
  script:
    - terraform init infra-as-code/basic-infra
    - terraform validate infra-as-code/basic-infra
  only:
    - master
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/

terraform-validate-network-resources:
  stage: validation
  extends: .terraform_validate_template
  script:
    - export TF_VAR_CURRENT_ENVIRONMENT="dev"
    - envsubst < infra-as-code/network-resources/init.tf > temp_network_resources_init.tf
    - mv temp_network_resources_init.tf infra-as-code/network-resources/init.tf
    - terraform init infra-as-code/network-resources
    - terraform validate infra-as-code/network-resources
  only:
    - master
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/

terraform-validate-dev:
  stage: validation
  extends: .terraform_validate_template
  script:
    - envsubst < infra-as-code/dev/init.tf > temp.tf
    - envsubst < infra-as-code/dev/variables.tf > temp_vars.tf
    - envsubst < infra-as-code/dev/references.tf > temp_references_dev.tf
    - mv temp.tf infra-as-code/dev/init.tf
    - mv temp_vars.tf infra-as-code/dev/variables.tf
    - mv temp_references_dev.tf infra-as-code/dev/references.tf
    - terraform init infra-as-code/dev
    - terraform validate infra-as-code/dev
  only:
    - master
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/


# ==================================================
# Terraform deployment jobs for infra-as-code module
# ==================================================
basic-infra:
  stage: basic_infra
  extends: .terraform_basic_template
  script:
    - terraform init infra-as-code/basic-infra
    - terraform apply -auto-approve infra-as-code/basic-infra
  only:
    - master
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/

network-resources-infra-branches:
  stage: basic_infra
  extends: .terraform_template_deploy_network-resources
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export TF_VAR_CURRENT_ENVIRONMENT="dev"
  only:
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  except:
    - master

network-resources-infra-master:
  stage: basic_infra
  extends: .terraform_template_deploy_network-resources
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export TF_VAR_CURRENT_ENVIRONMENT="production"
  only:
    - master

check-ecs-resources-branches:
  extends: .check_ecs_resources_template
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_bruin_bridge_desired_tasks=${bruin_bridge_desired_tasks}
    - export TF_VAR_last_contact_report_desired_tasks=${last_contact_report_desired_tasks}
    - export TF_VAR_metrics_prometheus_desired_tasks=${metrics_prometheus_desired_tasks}
    - export TF_VAR_nats_server_desired_tasks=${nats_server_desired_tasks}
    - export TF_VAR_nats_server_1_desired_tasks=${nats_server_1_desired_tasks}
    - export TF_VAR_nats_server_2_desired_tasks=${nats_server_2_desired_tasks}
    - export TF_VAR_notifier_desired_tasks=${notifier_desired_tasks}
    - export TF_VAR_service_affecting_monitor_desired_tasks=${service_affecting_monitor_desired_tasks}
    - export TF_VAR_service_outage_monitor_desired_tasks=${service_outage_monitor_desired_tasks}
    - export TF_VAR_sites_monitor_desired_tasks=${sites_monitor_desired_tasks}
    - export TF_VAR_t7_bridge_desired_tasks=${t7_bridge_desired_tasks}
    - export TF_VAR_velocloud_bridge_desired_tasks=${velocloud_bridge_desired_tasks}
  only:
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  except:
    - master

check-ecs-resources-master:
  extends: .check_ecs_resources_template
  before_script:
    - export ENVIRONMENT_SLUG=master
    - export TF_VAR_bruin_bridge_desired_tasks=${bruin_bridge_desired_tasks}
    - export TF_VAR_last_contact_report_desired_tasks=${last_contact_report_desired_tasks}
    - export TF_VAR_metrics_prometheus_desired_tasks=${metrics_prometheus_desired_tasks}
    - export TF_VAR_nats_server_desired_tasks=${nats_server_desired_tasks}
    - export TF_VAR_nats_server_1_desired_tasks=${nats_server_1_desired_tasks}
    - export TF_VAR_nats_server_2_desired_tasks=${nats_server_2_desired_tasks}
    - export TF_VAR_notifier_desired_tasks=${notifier_desired_tasks}
    - export TF_VAR_service_affecting_monitor_desired_tasks=${service_affecting_monitor_desired_tasks}
    - export TF_VAR_service_outage_monitor_desired_tasks=${service_outage_monitor_desired_tasks}
    - export TF_VAR_sites_monitor_desired_tasks=${sites_monitor_desired_tasks}
    - export TF_VAR_t7_bridge_desired_tasks=${t7_bridge_desired_tasks}
    - export TF_VAR_velocloud_bridge_desired_tasks=${velocloud_bridge_desired_tasks}
  only:
    - master

deploy-branches:
  stage: deploy
  extends: .terraform_template_deploy_environment
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_GRAFANA_USER_EMAIL=${GRAFANA_USER_EMAIL}
    - export TF_VAR_GRAFANA_USER_LOGIN=${GRAFANA_USER_LOGIN}
    - export TF_VAR_GRAFANA_USER_NAME=${GRAFANA_USER_NAME}
    - export TF_VAR_GRAFANA_USER_ROLE=${GRAFANA_USER_ROLE}
    - export TF_VAR_GRAFANA_USER_COMPANY=${GRAFANA_USER_COMPANY}
    - export TF_VAR_ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
    - export TF_VAR_SUBDOMAIN=${ENVIRONMENT_SLUG}
    - export TF_VAR_NATS_MODULE_VERSION=${NATS_MODULE_VERSION}
    - export TF_VAR_VELOCLOUD_CREDENTIALS=${VELOCLOUD_CREDENTIALS_PRO}
    - export TF_VAR_EMAIL_ACC_PWD=${EMAIL_ACC_PWD}
    - export TF_VAR_MONITORING_SECONDS=${MONITORING_SECONDS}
    - export TF_VAR_LAST_CONTACT_RECIPIENT=${LAST_CONTACT_RECIPIENT_DEV}
    - export TF_VAR_BRUIN_CLIENT_ID=${BRUIN_CLIENT_ID_PRO}
    - export TF_VAR_BRUIN_CLIENT_SECRET=${BRUIN_CLIENT_SECRET_PRO}
    - export TF_VAR_BRUIN_LOGIN_URL=${BRUIN_LOGIN_URL_PRO}
    - export TF_VAR_BRUIN_BASE_URL=${BRUIN_BASE_URL_PRO}
    - export TF_VAR_T7_BASE_URL=${T7_BASE_URL_DEV}
    - export TF_VAR_T7_TOKEN=${T7_TOKEN_DEV}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
    - export TF_VAR_SLACK_URL=${SLACK_URL_DEV}
    - export TF_VAR_ALARMS_SUBSCRIPTIONS_EMAIL_ADDRESS=${AWS_ALARMS_NOTIFIER_EMAIL}
    - export TF_VAR_bruin_bridge_desired_tasks=${bruin_bridge_desired_tasks}
    - export TF_VAR_last_contact_report_desired_tasks=${last_contact_report_desired_tasks}
    - export TF_VAR_metrics_prometheus_desired_tasks=${metrics_prometheus_desired_tasks}
    - export TF_VAR_nats_server_desired_tasks=${nats_server_desired_tasks}
    - export TF_VAR_nats_server_1_desired_tasks=${nats_server_1_desired_tasks}
    - export TF_VAR_nats_server_2_desired_tasks=${nats_server_2_desired_tasks}
    - export TF_VAR_notifier_desired_tasks=${notifier_desired_tasks}
    - export TF_VAR_service_affecting_monitor_desired_tasks=${service_affecting_monitor_desired_tasks}
    - export TF_VAR_service_outage_monitor_desired_tasks=${service_outage_monitor_desired_tasks}
    - export TF_VAR_sites_monitor_desired_tasks=${sites_monitor_desired_tasks}
    - export TF_VAR_t7_bridge_desired_tasks=${t7_bridge_desired_tasks}
    - export TF_VAR_velocloud_bridge_desired_tasks=${velocloud_bridge_desired_tasks}
  environment:
    name: $CI_COMMIT_REF_NAME
    url: http://${ENVIRONMENT_SLUG}.mettel-automation.net/
    on_stop: destroy-branches
  only:
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  except:
    - master

deploy-master:
  stage: deploy
  extends: .terraform_template_deploy_environment
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export ENVIRONMENT_SLUG=master
    - export TF_VAR_GRAFANA_USER_EMAIL=${GRAFANA_USER_EMAIL}
    - export TF_VAR_GRAFANA_USER_LOGIN=${GRAFANA_USER_LOGIN}
    - export TF_VAR_GRAFANA_USER_NAME=${GRAFANA_USER_NAME}
    - export TF_VAR_GRAFANA_USER_ROLE=${GRAFANA_USER_ROLE}
    - export TF_VAR_GRAFANA_USER_COMPANY=${GRAFANA_USER_COMPANY}
    - export TF_VAR_ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
    - export TF_VAR_SUBDOMAIN=${ENVIRONMENT_SLUG}
    - export TF_VAR_NATS_MODULE_VERSION=${NATS_MODULE_VERSION}
    - export TF_VAR_VELOCLOUD_CREDENTIALS=${VELOCLOUD_CREDENTIALS_PRO}
    - export TF_VAR_EMAIL_ACC_PWD=${EMAIL_ACC_PWD}
    - export TF_VAR_MONITORING_SECONDS=${MONITORING_SECONDS}
    - export TF_VAR_LAST_CONTACT_RECIPIENT=${LAST_CONTACT_RECIPIENT_PRO}
    - export TF_VAR_BRUIN_CLIENT_ID=${BRUIN_CLIENT_ID_PRO}
    - export TF_VAR_BRUIN_CLIENT_SECRET=${BRUIN_CLIENT_SECRET_PRO}
    - export TF_VAR_BRUIN_LOGIN_URL=${BRUIN_LOGIN_URL_PRO}
    - export TF_VAR_BRUIN_BASE_URL=${BRUIN_BASE_URL_PRO}
    - export TF_VAR_T7_BASE_URL=${T7_BASE_URL_PRO}
    - export TF_VAR_T7_TOKEN=${T7_TOKEN_PRO}
    - export TF_VAR_CURRENT_ENVIRONMENT=production
    - export TF_VAR_SLACK_URL=${SLACK_URL_PRO}
    - export TF_VAR_ALARMS_SUBSCRIPTIONS_EMAIL_ADDRESS=${AWS_ALARMS_NOTIFIER_EMAIL}
    - export TF_VAR_bruin_bridge_desired_tasks=${bruin_bridge_desired_tasks}
    - export TF_VAR_last_contact_report_desired_tasks=${last_contact_report_desired_tasks}
    - export TF_VAR_metrics_prometheus_desired_tasks=${metrics_prometheus_desired_tasks}
    - export TF_VAR_nats_server_desired_tasks=${nats_server_desired_tasks}
    - export TF_VAR_nats_server_1_desired_tasks=${nats_server_1_desired_tasks}
    - export TF_VAR_nats_server_2_desired_tasks=${nats_server_2_desired_tasks}
    - export TF_VAR_notifier_desired_tasks=${notifier_desired_tasks}
    - export TF_VAR_service_affecting_monitor_desired_tasks=${service_affecting_monitor_desired_tasks}
    - export TF_VAR_service_outage_monitor_desired_tasks=${service_outage_monitor_desired_tasks}
    - export TF_VAR_sites_monitor_desired_tasks=${sites_monitor_desired_tasks}
    - export TF_VAR_t7_bridge_desired_tasks=${t7_bridge_desired_tasks}
    - export TF_VAR_velocloud_bridge_desired_tasks=${velocloud_bridge_desired_tasks}
  environment:
    name: $CI_COMMIT_REF_NAME
    url: http://${ENVIRONMENT_SLUG}.mettel-automation.net:3000/
    on_stop: destroy-master
  only:
    - master

# ===============================================
# Terraform destroy jobs for infra-as-code module
# ===============================================
destroy-branches:
  stage: deploy
  extends: .terraform_template_destroy_environment
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER}
    - export TF_VAR_GRAFANA_USER_EMAIL=${GRAFANA_USER_EMAIL}
    - export TF_VAR_GRAFANA_USER_LOGIN=${GRAFANA_USER_LOGIN}
    - export TF_VAR_GRAFANA_USER_NAME=${GRAFANA_USER_NAME}
    - export TF_VAR_GRAFANA_USER_ROLE=${GRAFANA_USER_ROLE}
    - export TF_VAR_GRAFANA_USER_COMPANY=${GRAFANA_USER_COMPANY}
    - export TF_VAR_ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
    - export TF_VAR_SUBDOMAIN=${ENVIRONMENT_SLUG}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
    - export TF_VAR_SLACK_URL=${SLACK_URL_DEV}
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop
  when: manual
  only:
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  except:
    - master

destroy-branches-aws-nuke:
  stage: deploy
  extends: .destroy_environment_aws_nuke_template
  before_script:
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
  only:
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  except:
    - master

destroy-master:
  stage: deploy
  extends: .terraform_template_destroy_environment
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export ENVIRONMENT_SLUG=master
    - export TF_VAR_GRAFANA_USER_EMAIL=${GRAFANA_USER_EMAIL}
    - export TF_VAR_GRAFANA_USER_LOGIN=${GRAFANA_USER_LOGIN}
    - export TF_VAR_GRAFANA_USER_NAME=${GRAFANA_USER_NAME}
    - export TF_VAR_GRAFANA_USER_ROLE=${GRAFANA_USER_ROLE}
    - export TF_VAR_GRAFANA_USER_COMPANY=${GRAFANA_USER_COMPANY}
    - export TF_VAR_ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
    - export TF_VAR_SUBDOMAIN=${ENVIRONMENT_SLUG}
    - export TF_VAR_CURRENT_ENVIRONMENT=production
    - export TF_VAR_SLACK_URL=${SLACK_URL_PRO}
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop
  when: manual
  only:
    - master
