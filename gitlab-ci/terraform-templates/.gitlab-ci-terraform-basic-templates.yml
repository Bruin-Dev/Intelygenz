#
# Using gitlab-ci extends to reuse scripts between jobs (https://docs.gitlab.com/ee/ci/yaml/#extends)
#

.terraform_basic_template: &terraform_basic_template
  image:
    name: gitlab.intelygenz.com:5001/mettel/docker_images/terraform_0.12.7_awscli:${DOCKER_IMAGE_UTILS_VERSION}
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  before_script:
    - terraform init -backend=true -get=true -input=false
  only:
    - master
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  tags:
    - kubernetes

.terraform_validate_template: &terraform_validate_template
  image:
    name: gitlab.intelygenz.com:5001/mettel/docker_images/terraform_0.12.7_awscli:${DOCKER_IMAGE_UTILS_VERSION}
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  before_script:
    - terraform init -backend=true -get=true -input=false
    - export ENVIRONMENT_SLUG=$(echo -n "${CI_COMMIT_REF_SLUG}" | sha256sum | cut -c1-8)
    - export TF_VAR_ENVIRONMENT=automation-${ENVIRONMENT_SLUG}
    - export TF_VAR_VELOCLOUD_CREDENTIALS=${VELOCLOUD_CREDENTIALS_DEV}
    - export TF_VAR_EMAIL_ACC_PWD=${EMAIL_ACC_PWD}
    - export TF_VAR_MONITORING_SECONDS=${MONITORING_SECONDS}
    - export TF_VAR_LAST_CONTACT_RECIPIENT=${LAST_CONTACT_RECIPIENT_DEV}
    - export TF_VAR_BRUIN_CLIENT_ID_PRO=${BRUIN_CLIENT_ID_PRO}
    - export TF_VAR_BRUIN_CLIENT_SECRET_PRO=${BRUIN_CLIENT_SECRET_PRO}
    - export TF_VAR_BRUIN_LOGIN_URL_PRO=${BRUIN_LOGIN_URL_PRO}
    - export TF_VAR_BRUIN_BASE_URL_PRO=${BRUIN_BASE_URL_PRO}
    - export TF_VAR_LIT_CLIENT_ID=${LIT_CLIENT_ID_DEV}
    - export TF_VAR_LIT_CLIENT_SECRET=${LIT_CLIENT_SECRET_DEV}
    - export TF_VAR_LIT_USERNAME=${LIT_CLIENT_USERNAME_DEV}
    - export TF_VAR_LIT_PASSWORD_ID=${LIT_CLIENT_PASSWORD_DEV}
    - export TF_VAR_LIT_CLIENT_SECURITY_TOKEN=${LIT_CLIENT_SECURITY_TOKEN_DEV}
    - export TF_VAR_LIT_LOGIN_URL=${LIT_LOGIN_URL_DEV}
    - export TF_VAR_LIT_DOMAIN=${LIT_DOMAIN_DEV}
    - export TF_VAR_CURRENT_ENVIRONMENT=dev
  only:
    - master
    - /^*dev/feature/.*$/
    - /^*dev/fix/.*$/
  tags:
    - kubernetes