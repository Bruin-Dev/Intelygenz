##
# Using Gitlab-CI extends to reuse scripts between jobs (https://docs.gitlab.com/ee/ci/yaml/#extends)
#

.terraform_template_destroy_environment: &terraform_template_destroy_environment
  image:
    name: ${CI_REGISTRY}/mettel/docker_images/terraform_0.14_common_utils:${DOCKER_IMAGE_UTILS_VERSION}
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  script:
    - export TF_VAR_ENVIRONMENT_NAME=${ENVIRONMENT_SLUG}
    - export ENVIRONMENT_VAR=${TF_VAR_ENVIRONMENT}
    - cd "${MODULE}" || exit 1
    - >
      for i in $(find . -mindepth 1 -maxdepth 1 -type d | sort | sed 's|^./||' || exit 1); do
          (
              echo "Terraform directory $i"
              if [[ ${i} == "0-elasticaches" ]]; then
                cd "${i}" || exit 1
                for j in $(find . -mindepth 1 -maxdepth 1 -type d | sort | sed 's|^./||' || exit 1); do
                    (
                      cd "${j}" || exit
                      echo "Terraform module subdirectory ${j}"
                      terraform init -backend=true -get=true -input=false
                      terraform workspace new ${TF_VAR_CURRENT_ENVIRONMENT} || terraform workspace select ${TF_VAR_CURRENT_ENVIRONMENT}
                      terraform refresh
                      terraform destroy -auto-approve
                    )
                done
              else
                echo "Module without subdirectories, terraform workspace ${i}"
                terraform init -backend=true -get=true -input=false
                terraform workspace new ${TF_VAR_CURRENT_ENVIRONMENT} || terraform workspace select ${TF_VAR_CURRENT_ENVIRONMENT}
                terraform refresh
                terraform destroy -auto-approve
              fi
          )
      done
    - >
      if [ "$TF_VAR_CURRENT_ENVIRONMENT" == "production" ]; then
        apk add zip unzip
        export TF_VAR_REST_API_DATA_COLLECTOR_AUTH_TOKEN=${REST_API_DATA_COLLECTOR_AUTH_TOKEN}
        export TF_VAR_REST_API_DATA_COLLECTOR_MONGODB_COLLECTION=${REST_API_DATA_COLLECTOR_MONGODB_COLLECTION}
        export TF_VAR_REST_API_DATA_COLLECTOR_MONGODB_DATABASE=${REST_API_DATA_COLLECTOR_MONGODB_DATABASE}
        envsubst < infra-as-code/data-collector/init.tf > temp_dc.tf
        envsubst < infra-as-code/data-collector/variables.tf > temp_vars_dc.tf
        mv temp_dc.tf infra-as-code/data-collector/init.tf
        mv temp_vars_dc.tf infra-as-code/data-collector/variables.tf
        cd infra-as-code/data-collector
        terraform init
        terraform destroy -auto-approve
        cd ${CI_PROJECT_DIR}
      fi
    - python3 ci-utils/ecr/ecr_images_util.py -d True -e ${TF_VAR_ENVIRONMENT} -a True -p True
  tags:
    - kubernetes