# ===========================================================
# Linter validation jobs for dispatch-portal-frontend module
# ===========================================================
dispatch-portal-frontend-linter:
  stage: validation
  image: node:10
  variables:
    MODULE_NAME: dispatch-portal-frontend
  before_script:
    - npm install --prefix dispatch-portal-frontend
  script:
    - npm run lint --prefix dispatch-portal-frontend
  cache:
    policy: push
    key: "dispatch-portal-frontend-${CI_COMMIT_REF_SLUG}"
    paths:
      - dispatch-portal-frontend/node_modules
  rules:
#    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && $CI_PIPELINE_SOURCE == "push"'
#      changes:
#        - dispatch-portal-frontend/**/*
    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "merge_request_event") && $TEST_DISPATCH_PORTAL_FRONTEND == "true"'
  tags:
    - kubernetes

# ===================================================
# Unit tests jobs for dispatch-portal-frontend module
# ===================================================
dispatch-portal-frontend-test:
  stage: unit_test
  image: node:10
  variables:
    MODULE_NAME: dispatch-portal-frontend
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  script:
    - npm run test --prefix dispatch-portal-frontend
  cache:
    policy: pull
    key: "dispatch-portal-frontend-${CI_COMMIT_REF_SLUG}"
    paths:
      - dispatch-portal-frontend/node_modules
  rules:
#    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && $CI_PIPELINE_SOURCE == "push"'
#      changes:
#        - dispatch-portal-frontend/**/*
    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "merge_request_event") && $TEST_DISPATCH_PORTAL_FRONTEND == "true"'
  dependencies:
    - dispatch-portal-frontend-linter
  tags:
    - kubernetes
  needs: ["dispatch-portal-frontend-linter"]

dispatch-portal-frontend-test-e2e:
  stage: unit_test
  image: cypress/base:10
  variables:
    CI: 1
    MODULE_NAME: dispatch-portal-frontend
  before_script:
    - npm install --prefix dispatch-portal-frontend
    - npm run build --prefix dispatch-portal-frontend
  script:
    - npm run ci:test --prefix dispatch-portal-frontend
  rules:
#    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && $CI_PIPELINE_SOURCE == "push"'
#      changes:
#        - dispatch-portal-frontend/**/*
    - if: '($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "merge_request_event") && $TEST_DISPATCH_PORTAL_FRONTEND == "true"'
  tags:
    - kubernetes
  needs: ["dispatch-portal-frontend-linter"]

# =================================================================
# Images builds jobs for dispatch-portal-frontend module components
# =================================================================
dispatch-portal-frontend-build:
  stage: build
  variables:
    MODULE_NAME: dispatch-portal-frontend
    MODULE_VERSION: ${CI_PIPELINE_ID}
  script:
    - docker build --build-arg CURRENT_ENV="PRO" --build-arg DNS_ENVIRONMENT=${DNS_ENVIRONMENT_VAR}
      -t ${REPOSITORY_URL}/${MODULE_NAME}:${DOCKER_BUILD_LATEST_TAG}
      -t ${REPOSITORY_URL}/${MODULE_NAME}:${TAG}
      -f ${MODULE_NAME}/Dockerfile .
    - docker push ${REPOSITORY_URL}/${MODULE_NAME}:${DOCKER_BUILD_LATEST_TAG}
    - docker push ${REPOSITORY_URL}/${MODULE_NAME}:${TAG}
    - python3 ci-utils/ecr/ecr_images_util.py -e ${ENVIRONMENT_ID} -r ${MODULE_NAME} -d -o
  rules:
    - if: '($CI_COMMIT_BRANCH =~ /^(feature|fix)\/.+$/ || $CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/) && $DISPATCH_PORTAL_FRONTEND_DESIRED_TASKS != "0" && $CI_PIPELINE_SOURCE == "push"'
#      changes:
#        - dispatch-portal-frontend/**/*
      when: manual
      allow_failure: true
    - if: '$CI_COMMIT_BRANCH =~ /^dev\/(feature|fix)\/.+$/ && $DISPATCH_PORTAL_FRONTEND_DESIRED_TASKS != "0" && $CI_PIPELINE_SOURCE == "web"'
  extends: .build_app_image
  needs: ["dispatch-portal-frontend-test", "dispatch-portal-frontend-test-e2e"]
